{% extends 'base.html' %} {% block title %}ZADEET - Transactions{% endblock %}
{% block content %}
<header class="text-center mb-4">
  <h1 class="fw-bold">Gestionnaire de D√©penses - Transactions</h1>
</header>

{# ------------------- STATS ------------------- #}
<section class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="row text-center">
      <div class="col-md-3 mb-3 mb-md-0">
        <div class="fw-semibold text-secondary text-uppercase small">
          Total D√©penses
        </div>
        <div class="fs-3 fw-bold text-danger">
          - {{ '%.2f' | format(total_expenses or 0) }} ‚Ç¨
        </div>
      </div>
      <div class="col-md-3 mb-3 mb-md-0">
        <div class="fw-semibold text-secondary text-uppercase small">
          Total Revenus
        </div>
        <div class="fs-3 fw-bold text-success">
          + {{ '%.2f' | format(total_revenues or 0) }} ‚Ç¨
        </div>
      </div>
      <div class="col-md-3 mb-3 mb-md-0">
        <div class="fw-semibold text-secondary text-uppercase small">
          Cat√©gories
        </div>
        <div class="fs-3 fw-bold">{{ total_categories }}</div>
      </div>
      <div class="col-md-3">
        <div class="fw-semibold text-secondary text-uppercase small">
          Transactions
        </div>
        <div class="fs-3 fw-bold">{{ total_transactions }}</div>
      </div>
    </div>
  </div>
</section>

{# ------------------- BOUTONS D'ACTION ------------------- #}
<section class="d-flex flex-column flex-md-row gap-2 mb-4">
  <button
    class="btn btn-primary flex-fill"
    data-bs-toggle="modal"
    data-bs-target="#expenseModal"
    data-mode="create"
  >
    Ajouter une d√©pense
  </button>
  <a href="/categories/page" class="btn btn-secondary flex-fill text-center">
    G√©rer les cat√©gories
  </a>
</section>

{# ------------------- RECHERCHE ------------------- #}
<section class="card shadow-sm mb-4">
  <div class="card-body">
    <form
      method="get"
      action="/transactions/page"
      class="row g-2 align-items-end"
    >
      <div class="col-md-6">
        <label for="searchInput" class="form-label small mb-1"
          >Rechercher une transaction par sous-cat√©gorie</label
        >
        <input
          type="text"
          id="searchInput"
          name="search"
          class="form-control"
          placeholder="Ex : alimentation,cin√©ma ..."
          value="{{ search | default('') }}"
        />
      </div>
      <div class="col-md-2 d-grid">
        <button type="submit" class="btn btn-primary mt-3 mt-md-0">
          Filtrer
        </button>
      </div>
    </form>
  </div>
</section>

{# ------------------- PAR CAT√âGORIE ------------------- #}
<section class="card shadow-sm mb-4">
  <div class="card-body">
    <h2 class="h5 mb-3">Transactions par cat√©gorie</h2>

    {# LISTE DES SOMMES PAR CAT√âGORIE (NOUVEL AFFICHAGE) #}
    <div class="list-group mb-4">
      {% for cat in categories %}
      <div
        class="list-group-item d-flex justify-content-between align-items-center"
      >
        <span class="fw-semibold">{{ cat.name }}</span>
        {% set total = cat.total_amount | default(0) %} {% set is_revenu =
        cat.type == 'revenu' %}
        <span
          class="fw-bold {% if is_revenu %}text-success{% else %}text-danger{% endif %}"
        >
          {% if is_revenu %}+{% else %}-{% endif %} {{ '%.2f' | format(total) }}
          ‚Ç¨
        </span>
      </div>
      {% endfor %}
    </div>
    {# FIN NOUVEL AFFICHAGE #} {# D√©penses par cat√©gorie #} {% set expenses =
    transactions | selectattr('category', 'ne', None) |
    selectattr('category.type', 'equalto', 'depense') | list %} {% if expenses
    %}
    <h3 class="h6 mt-2">D√©penses par cat√©gorie</h3>
    {% for group in expenses | groupby('category.name') %}
    <div class="mb-3">
      <div class="d-flex justify-content-between align-items-center mb-1">
        <span class="fw-semibold">{{ group.grouper }}</span>
        <span class="badge bg-danger">
          - {{ '%.2f' | format(group.list | map(attribute='amount') | sum) }} ‚Ç¨
        </span>
      </div>
      <ul class="list-group">
        {% for t in group.list %}
        <li
          class="list-group-item d-flex justify-content-between align-items-center"
        >
          <div>
            <div class="fw-semibold">{{ t.label or 'D√©pense' }}</div>
            <div class="small text-muted">
              Date : {{ t.date.strftime('%Y-%m-%d') }}
            </div>
          </div>
          <div class="fw-bold text-danger">
            - {{ '%.2f' | format(t.amount) }} ‚Ç¨
          </div>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endfor %} {% else %}
    <p class="text-muted mb-2">Aucune d√©pense avec cat√©gorie pour le moment.</p>
    {% endif %} {# Revenus par cat√©gorie #} {% set incomes = transactions |
    selectattr('category', 'ne', None) | selectattr('category.type', 'equalto',
    'revenu') | list %} {% if incomes %}
    <hr class="my-3" />
    <h3 class="h6 mt-2">Revenus par cat√©gorie</h3>
    {% for group in incomes | groupby('category.name') %}
    <div class="mb-3">
      <div class="d-flex justify-content-between align-items-center mb-1">
        <span class="fw-semibold">{{ group.grouper }}</span>
        <span class="badge bg-success">
          + {{ '%.2f' | format(group.list | map(attribute='amount') | sum) }} ‚Ç¨
        </span>
      </div>
      <ul class="list-group">
        {% for t in group.list %}
        <li
          class="list-group-item d-flex justify-content-between align-items-center"
        >
          <div>
            <div class="fw-semibold">{{ t.label or 'Revenu' }}</div>
            <div class="small text-muted">
              Date : {{ t.date.strftime('%Y-%m-%d') }}
            </div>
          </div>
          <div class="fw-bold text-success">
            + {{ '%.2f' | format(t.amount) }} ‚Ç¨
          </div>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endfor %} {% endif %} {# Sans cat√©gorie #} {% set txns_no_category =
    transactions | selectattr('category', 'equalto', None) | list %} {% if
    txns_no_category %}
    <hr class="my-3" />
    <h3 class="h6">Sans cat√©gorie</h3>
    <ul class="list-group">
      {% for t in txns_no_category %}
      <li
        class="list-group-item d-flex justify-content-between align-items-center"
      >
        <div>
          <div class="fw-semibold">{{ t.label or 'Transaction' }}</div>
          <div class="small text-muted">
            Date : {{ t.date.strftime('%Y-%m-%d') }}
          </div>
        </div>
        {# par d√©faut on consid√®re sans cat√©gorie comme d√©pense #}
        <div class="fw-bold text-danger">
          - {{ '%.2f' | format(t.amount) }} ‚Ç¨
        </div>
      </li>
      {% endfor %}
    </ul>
    {% endif %}
  </div>
</section>

{# ------------------- TOUTES LES TRANSACTIONS ------------------- #}
<section class="card shadow-sm mb-4">
  <div class="card-body">
    <h2 class="h5 mb-3">Toutes les transactions</h2>
    {% if transactions %}
    <div class="list-group">
      {% for t in transactions %}
      <div
        class="list-group-item mb-2 d-flex justify-content-between align-items-center"
      >
        <div>
          <div class="fw-bold">{{ t.label or 'Transaction' }}</div>
          <div class="small text-muted">
            {% if t.category %} Cat√©gorie : {{ t.category.name }} - {% else %}
            Sans cat√©gorie - {% endif %} Date : {{ t.date.strftime('%Y-%m-%d')
            }}
          </div>
        </div>
        <div class="text-end ms-3">
          {% set is_revenu = t.category and t.category.type == 'revenu' %}
          <div
            class="fw-bold {% if is_revenu %}text-success{% else %}text-danger{% endif %}"
          >
            {% if is_revenu %}+{% else %}-{% endif %} {{ '%.2f' |
            format(t.amount) }} ‚Ç¨
          </div>

          <button
            type="button"
            class="btn btn-sm btn-outline-secondary me-2"
            data-bs-toggle="modal"
            data-bs-target="#expenseModal"
            data-mode="edit"
            data-id="{{ t.id }}"
            data-label="{{ t.label or '' }}"
            data-amount="{{ '%.2f' | format(t.amount) }}"
            data-category-id="{{ t.category.id if t.category else '' }}"
            data-date="{{ t.date.strftime('%Y-%m-%d') }}"
          >
            Modifier
          </button>

          <form
            method="post"
            action="/transactions/{{ t.id }}"
            class="d-inline"
          >
            <input type="hidden" name="method" value="delete" />
            <button type="submit" class="btn btn-sm btn-outline-danger">
              Supprimer
            </button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center text-muted py-4">
      <div class="fs-1">üí∞</div>
      <p class="mb-0">
        Aucune d√©pense enregistr√©e. Ajoutez votre premi√®re d√©pense !
      </p>
    </div>
    {% endif %}
  </div>
</section>

{# ------------------- MODAL CR√âER / MODIFIER ------------------- #}
<div class="modal fade" id="expenseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Nouvelle d√©pense</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Fermer"
        ></button>
      </div>
      <form method="post" action="/transactions/">
        <div class="modal-body">
          <input type="hidden" name="is_expense" value="true" />

          <div class="mb-3">
            <label for="expenseLabel" class="form-label"
              >Nom de la d√©pense</label
            >
            <input
              type="text"
              class="form-control"
              id="expenseLabel"
              name="label"
              required
            />
          </div>

          <div class="mb-3">
            <label for="expenseAmount" class="form-label">Montant (‚Ç¨)</label>
            <input
              type="number"
              class="form-control"
              id="expenseAmount"
              name="amount"
              step="0.01"
              required
            />
          </div>

          <div class="mb-3">
            <label for="expenseCategory" class="form-label">Cat√©gorie</label>
            <select class="form-select" id="expenseCategory" name="category_id">
              <option value="">Sans cat√©gorie</option>
              {% for cat in categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label for="expenseDate" class="form-label">Date</label>
            <input
              type="date"
              class="form-control"
              id="expenseDate"
              name="date"
              required
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Annuler
          </button>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %} {% block body_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const expenseModal = document.getElementById("expenseModal");
    const dateInput = document.getElementById("expenseDate");
    const labelInput = document.getElementById("expenseLabel");
    const amountInput = document.getElementById("expenseAmount");
    const categorySelect = document.getElementById("expenseCategory");
    const form = expenseModal.querySelector("form");
    const title = expenseModal.querySelector(".modal-title");

    function setTodayIfEmpty() {
      if (dateInput && !dateInput.value) {
        const today = new Date().toISOString().slice(0, 10);
        dateInput.value = today;
      }
    }

    setTodayIfEmpty();

    expenseModal.addEventListener("show.bs.modal", function (event) {
      const button = event.relatedTarget;
      const mode = button.getAttribute("data-mode") || "create";

      if (mode === "create") {
        // Mode cr√©ation
        title.textContent = "Nouvelle d√©pense";
        form.action = "/transactions/";
        labelInput.value = "";
        amountInput.value = "";
        categorySelect.value = "";
        setTodayIfEmpty();
      } else if (mode === "edit") {
        // Mode √©dition
        const id = button.getAttribute("data-id");
        const label = button.getAttribute("data-label") || "";
        const amount = button.getAttribute("data-amount") || "";
        const categoryId = button.getAttribute("data-category-id") || "";
        const date = button.getAttribute("data-date") || "";

        title.textContent = "Modifier la d√©pense";
        form.action = `/transactions/${id}/update`;

        labelInput.value = label;
        amountInput.value = amount;
        categorySelect.value = categoryId;
        if (date) {
          dateInput.value = date;
        } else {
          setTodayIfEmpty();
        }
      }
    });
  });
</script>
{% endblock %}
