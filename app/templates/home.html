{% extends 'base.html' %}

{% block title %}ZADEET - Tableau de Bord{% endblock %}

{% block head_extras %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.transaction-list { padding-left: 1rem; margin-bottom: 0; }
</style>
{% endblock %}

{% block content %}
<header class="text-center mb-4">
    <h1 class="fw-bold">Tableau de Bord</h1>
    <p class="text-muted">Vue d'ensemble de vos finances</p>
</header>

<!-- Solde actuel -->
<section class="card shadow-sm mb-4 border-0">
    <div class="card-body text-center py-4">
        <div class="text-uppercase text-secondary fw-semibold small">Solde Actuel</div>
        <div class="display-4 fw-bold" id="totalBalanceDisplay">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span class="fs-4 text-muted">Chargement...</span>
        </div>
    </div>
</section>

<!-- Filtrage des transactions -->
<section class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="card-title fw-bold mb-3">Filtrer les transactions</h5>
        <div class="row g-2 align-items-end">
            <div class="col-md-6">
                <label for="filterPeriod" class="form-label small text-muted">Période</label>
                <select id="filterPeriod" class="form-select">
                    <option value="current_month" selected>Mois en cours</option>
                    <option value="last_month">Mois dernier</option>
                    <option value="last_3_months">3 derniers mois</option>
                    <option value="all">Tout l'historique</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="filterCategory" class="form-label small text-muted">Catégorie</label>
                <select id="filterCategory" class="form-select">
                    <option value="">Toutes les catégories</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-12 mt-2">
                <button class="btn btn-primary w-100" onclick="applyFilters()">Voir & Filtrer</button>
            </div>
        </div>
    </div>
</section>

<!-- Graphiques -->
<div class="row mb-4">
    <div class="col-lg-6 mb-3 mb-lg-0">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white fw-bold">Revenus vs Dépenses (3 mois)</div>
            <div class="card-body">
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white fw-bold">Répartition ce mois (Catégories)</div>
            <div class="card-body">
                <canvas id="pieChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Transactions récentes -->
<section class="card shadow-sm mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold">Transactions</h5>
        <small class="text-muted">Aperçu rapide</small>
    </div>
    <div class="card-body p-0">
        <div class="list-group list-group-flush" id="transactionList">
            {% if recent_transactions %}
                {% for t in recent_transactions %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">{{ t.label }}</div>
                        <div class="small text-muted">
                            {{ t.date.strftime('%d/%m/%Y') }}
                            {% if t.category %}• {{ t.category.name }}{% endif %}
                        </div>
                    </div>
                    <div class="fw-bold {% if t.category.type == 'revenu' %}text-success{% else %}text-danger{% endif %}">
                        {% if t.category.type == 'revenu' %}+{% else %}-{% endif %}
                        {{ '%.2f' | format(t.amount) }} €
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="p-4 text-center text-muted">Aucune transaction récente.</div>
            {% endif %}
        </div>
    </div>
</section>

<!-- Transactions par catégorie 
<section class="card shadow-sm mb-4">
    <div class="card-header fw-bold">Catégories et Transactions</div>
    <div class="card-body">
        {% for c in categories %}
        <div class="mb-3">
            <strong>{{ c.name }}</strong> <span class="badge bg-secondary">{{ c.type }}</span>
            {% if c.transactions %}
            <ul class="ps-3 mt-1 transaction-list">
                {% for t in c.transactions %}
                <li>{{ t.label }} — <span class="text-success">{{ t.amount }} €</span> ({{ t.date.strftime('%Y-%m-%d') }})</li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</section> -->
{% endblock %}

{% block body_scripts %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let barChartInstance;
    let pieChartInstance;
    function updateBarChart(labels, revenus, depenses) {
        if(!barChartInstance) return;
        barChartInstance.data.labels = labels;
        barChartInstance.data.datasets[0].data = revenus;
        barChartInstance.data.datasets[1].data = depenses;
        barChartInstance.update();
    }

    function updatePieChart(labels, data) {
        if(!pieChartInstance) return;
        pieChartInstance.data.labels = labels;
        pieChartInstance.data.datasets[0].data = data;
        pieChartInstance.update();
    }

async function loadBalance() {
    const display = document.getElementById('totalBalanceDisplay');
    try {
        const res = await fetch('/api/total-balance');
        const data = await res.json();
        const solde = data.total_balance ?? 0;
        display.innerText = solde.toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2}) + " €";
        display.classList.remove('text-success','text-danger');
        display.classList.add(solde >= 0 ? 'text-success' : 'text-danger');
    } catch(err) {
        display.innerHTML = "1 250,00 € <small class='fs-6 text-muted'>(Démo)</small>";
        display.classList.add('text-success');
        console.warn("API solde non accessible", err);
    }
}

async function loadCharts() {
    try {
        const res = await fetch('/api/dashboard-charts');
        const data = await res.json();

        // Bar Chart
        barChartInstance = new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: {
                labels: data.bar_chart.labels,
                datasets: [
                    { label: 'Revenus', data: data.bar_chart.revenus, backgroundColor: '#0d6efd' },
                    { label: 'Dépenses', data: data.bar_chart.depenses, backgroundColor: '#dc3545' }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: true } },
                scales: { y: { beginAtZero: true } }
            }
        });

        // Pie Chart
        pieChartInstance = new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: {
                labels: data.pie_chart.labels,
                datasets: [{ data: data.pie_chart.data, backgroundColor: ['#0d6efd','#6610f2','#6f42c1','#d63384','#198754'] }]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let value = context.raw || 0;
                                return context.label + ': ' + value.toLocaleString('fr-FR') + ' €';
                            }
                        }
                    }
                }
            }
        });


    } catch(err) {
        console.warn("Erreur lors du chargement des graphiques", err);
    }
}

// Filtrage des transactions
async function applyFilters() {
    const category_id = document.getElementById('filterCategory').value;
    const period = document.getElementById('filterPeriod').value;
    const params = new URLSearchParams();
    if(category_id) params.append('category_id', category_id);
    if(period) params.append('period', period);

    const container = document.getElementById('transactionList');
    container.innerHTML = `<div class="text-center p-4"><span class="spinner-border" role="status"></span> Chargement...</div>`;

    try {
        const res = await fetch('/transactions/filter?' + params.toString());
        if(!res.ok) throw new Error("API non disponible");
        const transactions = await res.json();

        if(!transactions.length){
            container.innerHTML = `<div class="p-4 text-center text-muted">Aucune transaction trouvée</div>`;
            return;
        }

        // Afficher la liste des transactions
        container.innerHTML = transactions.map(t => `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <div class="fw-bold">${t.label}</div>
                    <div class="small text-muted">${t.date} ${t.category_name ? '• ' + t.category_name : ''}</div>
                </div>
                <div class="fw-bold ${t.category_type === 'revenu' ? 'text-success' : 'text-danger'}">
                    ${t.category_type === 'revenu' ? '+' : '-'}${t.amount.toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2})} €
                </div>
            </div>
        `).join('');

        // ---- Mettre à jour les graphiques ----

        // Bar chart : Revenus vs Dépenses
        let revenus = transactions.map(t => t.category_type === 'revenu' ? t.amount : 0);
        let depenses = transactions.map(t => t.category_type === 'depense' ? t.amount : 0);
        let labels = transactions.map(t => t.label);
        updateBarChart(labels, revenus, depenses);

        // Pie chart : Répartition par catégorie
        let pieLabels = [];
        let pieData = [];
        let categoryMap = {};
        transactions.forEach(t => {
            let name = t.category_name || 'Autres';
            if(!categoryMap[name]) categoryMap[name] = 0;
            categoryMap[name] += t.amount;
        });
        for(let key in categoryMap){
            pieLabels.push(key);
            pieData.push(categoryMap[key]);
        }
        updatePieChart(pieLabels, pieData);


    } catch(err){
        container.innerHTML = `<div class="p-4 text-center text-danger">Erreur lors du filtrage</div>`;
        console.error("Erreur filtrage transactions", err);
    }
}

window.onload = function() {
    loadBalance();
    loadCharts();
};
</script>
{% endblock %}
