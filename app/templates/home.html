{% extends 'base.html' %}

{% block title %}ZADEET - Tableau de Bord{% endblock %}

{% block head_extras %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.transaction-list { padding-left: 1rem; margin-bottom: 0; }
</style>
{% endblock %}

{% block content %}
<header class="text-center mb-4">
    <div class="mb-4">
        <img src="/static/logo.png" alt="Zadeet Logo" class="home-logo">
    </div>
    <h1 class="fw-bold">Tableau de Bord</h1>
    <p class="text-muted">Vue d'ensemble de vos finances</p>
</header>

<!-- Solde actuel -->
<section class="card shadow-sm mb-4 border-0">
    <div class="card-body text-center py-4">
        <div class="text-uppercase text-secondary fw-semibold small">Solde Actuel</div>
        <div class="display-4 fw-bold" id="totalBalanceDisplay">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span class="fs-4 text-muted">Chargement...</span>
        </div>
    </div>
</section>

<!-- Filtrage des transactions -->
<section class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="card-title fw-bold mb-3">Filtrer les transactions</h5>
        <div class="row g-2 align-items-end">
            <div class="col-md-6">
                <label for="filterPeriod" class="form-label small text-muted">Période</label>
                <select id="filterPeriod" class="form-select">
                    <option value="current_month" selected>Mois en cours</option>
                    <option value="last_month">Mois dernier</option>
                    <option value="last_3_months">3 derniers mois</option>
                    <option value="all">Tout l'historique</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="filterCategory" class="form-label small text-muted">Catégorie</label>
                <select id="filterCategory" class="form-select">
                    <option value="">Toutes les catégories</option>
                    
                    <!-- Affichage Hiérarchique -->
                    {% for cat in categories %}
                        <option value="{{ cat.id }}" class="fw-bold">{{ cat.name }}</option>
                        {% for sub in cat.subcategories %}
                            <option value="{{ sub.id }}">&nbsp;&nbsp;&nbsp;&nbsp;↳ {{ sub.name }}</option>
                        {% endfor %}
                    {% endfor %}
                    
                </select>
            </div>
            <div class="col-md-12 mt-2 d-flex gap-2">
                <button class="btn btn-primary flex-grow-1" onclick="applyFilters()">
                    Voir & Filtrer
                </button>
                <button class="btn btn-outline-secondary" onclick="window.location.href='/'">
                    Réinitialiser
                </button>
            </div>
        </div>
    </div>
</section>

<!-- Graphiques -->
<div class="row mb-4">
    <div class="col-lg-6 mb-3 mb-lg-0">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white fw-bold">Revenus vs Dépenses</div>
            <div class="card-body">
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white fw-bold">Répartition (Dépenses)</div>
            <div class="card-body">
                <canvas id="pieChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Transactions récentes -->
<section class="card shadow-sm mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold">Transactions</h5>
        <small class="text-muted">Aperçu rapide</small>
    </div>
    <div class="card-body p-0">
        <div class="list-group list-group-flush" id="transactionList">
            {% if recent_transactions %}
                {% for t in recent_transactions %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">{{ t.label }}</div>
                        <div class="small text-muted">
                            {{ t.date.strftime('%d/%m/%Y') }}
                            {% if t.category %}• {{ t.category.name }}{% endif %}
                        </div>
                    </div>
                    <div class="fw-bold {% if t.category.type == 'revenu' %}text-success{% else %}text-danger{% endif %}">
                        {% if t.category.type == 'revenu' %}+{% else %}-{% endif %}
                        {{ '%.2f' | format(t.amount) }} €
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="p-4 text-center text-muted">Aucune transaction récente.</div>
            {% endif %}
        </div>
    </div>
</section>

{% endblock %}

{% block body_scripts %}
<script>
    let barChartInstance;
    let pieChartInstance;

    function updateBarChart(labels, revenus, depenses) {
        if(!barChartInstance) return;
        barChartInstance.data.labels = labels;
        barChartInstance.data.datasets[0].data = revenus;
        barChartInstance.data.datasets[1].data = depenses;
        barChartInstance.update();
    }

    function updatePieChart(labels, data, customTooltips) {
        if(!pieChartInstance) return;
        pieChartInstance.data.labels = labels;
        pieChartInstance.data.datasets[0].data = data;
        
        // On écrase les tooltips
        pieChartInstance.data.customTooltips = customTooltips;
        
        pieChartInstance.update();
    }

    async function loadBalance() {
        const display = document.getElementById('totalBalanceDisplay');
        try {
            const res = await fetch('/api/total-balance');
            const data = await res.json();
            const solde = data.total_balance ?? 0;
            display.innerText = solde.toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2}) + " €";
            display.classList.remove('text-success','text-danger');
            display.classList.add(solde >= 0 ? 'text-success' : 'text-danger');
        } catch(err) {
            console.warn("API solde non accessible", err);
        }
    }

    async function loadCharts() {
        try {
            const res = await fetch('/api/dashboard-charts');
            const data = await res.json();
            const pieData = data.pie_chart; // Important pour l'init

            // Bar Chart
            barChartInstance = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: {
                    labels: data.bar_chart.labels,
                    datasets: [
                        { label: 'Revenus', data: data.bar_chart.revenus, backgroundColor: '#198754' },
                        { label: 'Dépenses', data: data.bar_chart.depenses, backgroundColor: '#dc3545' }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });

            // Pie Chart
            pieChartInstance = new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: {
                    labels: pieData.labels,
                    datasets: [{ data: pieData.data, backgroundColor: ['#0d6efd','#6610f2','#6f42c1','#d63384','#198754', '#ffc107', '#0dcaf0'] }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let value = context.raw || 0;
                                    let index = context.dataIndex;
                                    let details = "";
                                    
                                    // Priorité 1 : Tooltips dynamiques (JS Filter)
                                    if (context.chart.data.customTooltips && context.chart.data.customTooltips[index]) {
                                        details = ` (${context.chart.data.customTooltips[index]})`;
                                    } 
                                    // Priorité 2 : Tooltips initiaux (Python Load)
                                    else if (pieData.tooltips && pieData.tooltips[index]) {
                                        details = ` (${pieData.tooltips[index]})`;
                                    }
                                    
                                    return context.label + ': ' + value.toLocaleString('fr-FR') + ' €' + details;
                                }
                            }
                        }
                    }
                }
            });
        } catch(err) { console.warn(err); }
    }

    // --- CŒUR DU FILTRAGE DYNAMIQUE ---
    async function applyFilters() {
        const category_id = document.getElementById('filterCategory').value;
        const period = document.getElementById('filterPeriod').value;
        
        // Est-ce qu'on filtre spécifiquement une catégorie ?
        const isFilteringByCategory = category_id !== "";

        const params = new URLSearchParams();
        if(category_id) params.append('category_id', category_id);
        if(period) params.append('period', period);

        const container = document.getElementById('transactionList');
        container.innerHTML = `<div class="text-center p-4"><span class="spinner-border" role="status"></span> Chargement...</div>`;

        try {
            const res = await fetch('/transactions/filter?' + params.toString());
            if(!res.ok) throw new Error("API non disponible");
            const transactions = await res.json();

            if(!transactions.length){
                container.innerHTML = `<div class="p-4 text-center text-muted">Aucune transaction trouvée</div>`;
                updateBarChart([], [], []);
                updatePieChart([], [], []);
                return;
            }

            // Afficher la liste HTML
            container.innerHTML = transactions.map(t => `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">${t.label}</div>
                        <div class="small text-muted">${t.date} ${t.category_name ? '• ' + t.category_name : ''}</div>
                    </div>
                    <div class="fw-bold ${t.category_type === 'revenu' ? 'text-success' : 'text-danger'}">
                        ${t.category_type === 'revenu' ? '+' : '-'}${t.amount.toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2})} €
                    </div>
                </div>
            `).join('');

            // Mise à jour Bar Chart
            let revenus = transactions.map(t => t.category_type === 'revenu' ? t.amount : 0);
            let depenses = transactions.map(t => t.category_type === 'depense' ? t.amount : 0);
            let labels = transactions.map(t => t.label);
            updateBarChart(labels, revenus, depenses);

            // --- Mise à jour Pie Chart (Le fameux Zoom) ---
            let categoryMap = {}; 
            let tooltipDetails = {}; 

            transactions.forEach(t => {
                // On ne garde que les dépenses pour le camembert
                if (t.category_type !== 'depense') return;

                let groupKey;
                
                if (isFilteringByCategory) {
                    // CAS ZOOM : On a choisi "Alimentation" -> On veut voir "Courses", "Resto"
                    // Ici on utilise category_name envoyé par le Backend
                    groupKey = t.category_name || 'Autres';
                } else {
                    // CAS GLOBAL : On veut voir les PARENTS ("Alimentation", "Logement")
                    // Ici on utilise parent_name envoyé par le Backend
                    groupKey = t.parent_name || 'Autres';
                }

                if (!categoryMap[groupKey]) {
                    categoryMap[groupKey] = 0;
                }
                categoryMap[groupKey] += t.amount;
            });

            let pieLabels = [];
            let pieData = [];
            let pieTooltips = [];

            for(let key in categoryMap){
                pieLabels.push(key);
                pieData.push(categoryMap[key]);
                // En mode filtre JS, on met des tooltips vides pour ne pas afficher de bêtises
                // (ou on pourrait recréer la logique des sous-catégories si besoin)
                pieTooltips.push(""); 
            }
            
            updatePieChart(pieLabels, pieData, pieTooltips);

        } catch(err){
            container.innerHTML = `<div class="p-4 text-center text-danger">Erreur lors du filtrage</div>`;
            console.error(err);
        }
    }

    window.onload = function() {
        loadBalance();
        loadCharts();
    };
</script>
{% endblock %}