<!doctype html>
<html lang="fr">
 <head>
  <meta charset="UTF-8">
  <title>Gestion de Dépenses</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"><script src="https://cdn.tailwindcss.com"></script><script src="/_sdk/element_sdk.js"></script>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="w-full h-full">
  <header class="w-full">
   <div class="app-wrapper min-h-full w-full flex items-stretch justify-center bg-slate-900 py-6 px-4">
    <div id="app-root" class="main-content w-full max-w-5xl rounded-2xl bg-slate-800/80 shadow-xl border border-slate-700 flex flex-col gap-6 p-6"><section class="w-full" aria-labelledby="main-title">
      <div class="flex flex-col sm:flex-row sm:items-baseline sm:justify-between gap-3">
       <div>
        <h1 id="main-title" class="text-2xl font-semibold text-white tracking-tight">Gestion des dépenses</h1>
        <p id="subtitle" class="mt-1 text-sm text-slate-300">Suivez vos plafonds et vos dépenses par catégorie.</p>
       </div>
       
       <div class="inline-flex items-center gap-3">
         <div class="relative">
            <select id="month-select" class="rounded-full border border-slate-700 bg-slate-800/80 text-slate-100 text-xs font-medium pl-3 pr-8 py-1 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-orange-400 appearance-none cursor-pointer">
              <option value="loading">Chargement des mois...</option>
              </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-400">
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
         </div>
         <div id="current-month-indicator" class="inline-flex items-center gap-2 bg-slate-700/70 rounded-full px-3 py-1 hidden"><span class="inline-flex h-2 w-2 rounded-full bg-emerald-400"></span> <span class="text-xs text-slate-100 font-medium">Mois en cours</span>
         </div>
       </div>
       </div>
     </section>

     <main class="w-full flex flex-col items-center gap-6" aria-label="Gestion des dépenses">
      <div class="w-full max-w-xl flex flex-col gap-6">
        <section class="w-full flex flex-col gap-4" aria-labelledby="categories-title">
         <div class="rounded-xl bg-slate-900/60 border border-slate-700 p-4">
          <h2 id="categories-title" class="text-lg font-semibold text-white mb-3">Catégories et plafonds</h2><div class="mb-3"><label for="category-select" class="block text-sm font-medium text-slate-200 mb-1"> Catégorie de dépense </label> <select id="category-select" name="category-select" class="w-full rounded-lg border border-slate-600 bg-slate-800/80 text-slate-100 text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-orange-400"> </select>
           <p class="mt-1 text-xs text-slate-400">Choisissez une catégorie, puis ajustez son plafond ou ajoutez des dépenses.</p>
          </div><form id="limit-form" class="space-y-3" aria-label="Formulaire de plafond">
           <div><label for="limit-input" class="block text-sm font-medium text-slate-200 mb-1"> Plafond mensuel (€) </label>
            <div class="flex items-center gap-2"><input id="limit-input" name="limit-input" type="number" min="0" step="1" class="flex-1 rounded-lg border border-slate-600 bg-slate-800/80 text-slate-100 text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-orange-400" aria-describedby="limit-help"> <button type="submit" id="save-limit-btn" class="inline-flex items-center justify-center rounded-lg bg-orange-500 text-white text-sm font-medium px-3 py-2 shadow-sm hover:bg-orange-400 transition-colors disabled:opacity-60 disabled:cursor-not-allowed"> Enregistrer </button>
            </div>
            <p id="limit-help" class="mt-1 text-xs text-slate-400">Modifiez le plafond pour la catégorie sélectionnée.</p>
           </div>
          </form>
         </div>
        </section>

        <section class="w-full flex flex-col gap-3" aria-labelledby="messages-title">
         <div id="message-box" class="rounded-xl bg-slate-900/60 border border-slate-700 p-3 text-xs text-slate-200 hidden" aria-live="polite"></div>
        </section>
      </div>
     </main>

     <section class="w-full" aria-labelledby="analytics-title">
      <h2 id="analytics-title" class="text-xl font-semibold text-white mb-4">Statistiques détaillées</h2>

      <div class="flex justify-start border-b border-slate-700 mb-4">
        <button id="tab-depenses" data-target="chart-depenses" class="tab-button py-2 px-4 text-sm font-medium text-white border-b-2 border-orange-500 transition-colors">Dépenses par catégorie</button>
        <button id="tab-utilisation" data-target="chart-utilisation" class="tab-button py-2 px-4 text-sm font-medium text-slate-400 border-b-2 border-transparent hover:text-slate-200 hover:border-slate-500 transition-colors">Taux d'utilisation des plafonds</button>
        <button id="tab-recherche" data-target="chart-recherche" class="tab-button py-2 px-4 text-sm font-medium text-slate-400 border-b-2 border-transparent hover:text-slate-200 hover:border-slate-500 transition-colors">Recherche Catégorie</button>
      </div>

      <div id="charts-container" class="rounded-xl bg-slate-900/60 border border-slate-700 p-4">

        <div id="chart-depenses" class="chart-panel">
          <h3 class="text-sm font-semibold text-slate-100 mb-3">Dépenses par catégorie</h3>
          <div class="h-64 flex items-end justify-around gap-2 px-2">
           <div id="vertical-chart" class="w-full h-full flex items-end justify-around gap-3"></div>
          </div>
        </div>

        <div id="chart-utilisation" class="chart-panel hidden">
          <h3 class="text-sm font-semibold text-slate-100 mb-3">Taux d'utilisation des plafonds</h3>
          <div class="h-64 flex flex-col justify-center gap-4 px-2">
           <div id="usage-chart" class="w-full flex flex-col gap-3"></div>
          </div>
        </div>
        
        <div id="chart-recherche" class="chart-panel hidden">
          <h3 class="text-sm font-semibold text-slate-100 mb-3">Rechercher les détails d'une catégorie</h3>
          
          <div class="mb-4">
            <label for="search-category-select" class="block text-sm font-medium text-slate-200 mb-1">Sélectionner une catégorie</label>
            <select id="search-category-select" name="search-category-select" class="w-full rounded-lg border border-slate-600 bg-slate-800/80 text-slate-100 text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-orange-400">
              </select>
          </div>
          
          <div class="bg-slate-800/80 rounded-lg p-4 border border-slate-700 space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-slate-300">Dépenses totales:</span>
              <span id="search-depense-total" class="text-lg font-bold text-orange-400">0€</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-slate-300">Plafond fixé:</span>
              <span id="search-plafond" class="text-lg font-bold text-emerald-400">0€</span>
            </div>
          </div>
          
          <p id="search-status" class="mt-2 text-xs text-slate-400 text-center"></p>
        </div>

      </div>
     </section>
    </div>
   </div>
  </header>
  <footer class="w-full">
   <div class="max-w-5xl mx-auto px-4 pb-4 flex justify-end">
    <p id="footer-text" class="text-[11px] text-slate-500">Exemple de dashboard de gestion de dépenses.</p>
   </div>
  </footer>
  <script>
    // --------- CONFIG / ELEMENT SDK (couleurs, texte, typo) ---------
    const defaultConfig = {
      // Couleurs (max 5)
      background_color: "#020617",       // BACKGROUND
      surface_color: "#020617",          // SECONDARY_SURFACE (on joue sur l’opacité en CSS)
      text_color: "#e5e7eb",             // TEXT (gris très clair)
      primary_action_color: "#22c55e",   // PRIMARY_ACTION (bouton vert)
      secondary_action_color: "#f97316", // SECONDARY_ACTION (orange)

      // Police & taille
      font_family: "Inter",
      font_size: 14,

      // Textes éditables
      main_title: "Gestion des dépenses",
      subtitle: "Suivez vos plafonds et vos dépenses par catégorie.",
      category_section_title: "Catégories et plafonds",
      save_limit_label: "Enregistrer",
      footer_text: "Exemple de dashboard de gestion de dépenses."
    };

    function applyConfigToUI(config) {
      const cfg = config || defaultConfig;

      const appWrapper = document.querySelector(".app-wrapper");
      const mainContent = document.querySelector(".main-content");
      const titleEl = document.getElementById("main-title");
      const subtitleEl = document.getElementById("subtitle");
      const catTitleEl = document.getElementById("categories-title");
      const saveLimitBtn = document.getElementById("save-limit-btn");
      const footerText = document.getElementById("footer-text");

      const baseFontStack = "system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
      const customFont = cfg.font_family || defaultConfig.font_family;
      const baseSize = Number(cfg.font_size || defaultConfig.font_size);

      const fullFontStack = customFont + ", " + baseFontStack;

      if (appWrapper) {
        appWrapper.style.backgroundColor = cfg.background_color || defaultConfig.background_color;
      }
      if (mainContent) {
        mainContent.style.backgroundColor = "rgba(15,23,42,0.9)"; // reste très proche de surface_color
        mainContent.style.color = cfg.text_color || defaultConfig.text_color;
        mainContent.style.fontFamily = fullFontStack;
        mainContent.style.fontSize = baseSize + "px";
      }

      if (titleEl) {
        titleEl.textContent = cfg.main_title || defaultConfig.main_title;
        titleEl.style.fontFamily = fullFontStack;
        titleEl.style.fontSize = baseSize * 1.6 + "px";
        titleEl.style.color = cfg.text_color || defaultConfig.text_color;
      }

      if (subtitleEl) {
        subtitleEl.textContent = cfg.subtitle || defaultConfig.subtitle;
        subtitleEl.style.fontFamily = fullFontStack;
        subtitleEl.style.fontSize = baseSize * 0.9 + "px";
        subtitleEl.style.color = cfg.text_color || defaultConfig.text_color;
      }

      if (catTitleEl) {
        catTitleEl.textContent = cfg.category_section_title || defaultConfig.category_section_title;
        catTitleEl.style.fontFamily = fullFontStack;
        catTitleEl.style.fontSize = baseSize * 1.1 + "px";
        catTitleEl.style.color = cfg.text_color || defaultConfig.text_color;
      }


      if (saveLimitBtn) {
        saveLimitBtn.textContent = cfg.save_limit_label || defaultConfig.save_limit_label;
        saveLimitBtn.style.backgroundColor = cfg.secondary_action_color || defaultConfig.secondary_action_color;
      }

      if (footerText) {
        footerText.textContent = cfg.footer_text || defaultConfig.footer_text;
        footerText.style.fontFamily = fullFontStack;
        footerText.style.fontSize = baseSize * 0.8 + "px";
        footerText.style.color = "#64748b";
      }

      // Appliquer couleur de texte globale
      const labels = document.querySelectorAll("label, dt, dd, p, span, button, input, select, h3");
      labels.forEach(function (el) {
        if (!el.classList.contains("text-slate-400") &&
            !el.classList.contains("text-slate-300") &&
            !el.classList.contains("text-slate-500") &&
            !el.classList.contains("text-emerald-300") &&
            !el.classList.contains("text-orange-300")) {
          el.style.color = cfg.text_color || defaultConfig.text_color;
        }
        el.style.fontFamily = fullFontStack;
      });

      // Appliquer couleurs sur chart (sera re-appliqué après chaque redraw)
      redrawChart();
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig: defaultConfig,
        onConfigChange: async function (config) {
          applyConfigToUI(config);
        },
        mapToCapabilities: function (config) {
          const cfg = config || defaultConfig;
          return {
            recolorables: [
              {
                get: () => cfg.background_color || defaultConfig.background_color,
                set: (value) => {
                  cfg.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => cfg.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  cfg.surface_color = value;
                  window.elementSdk.setConfig({ surface_color: value });
                }
              },
              {
                get: () => cfg.text_color || defaultConfig.text_color,
                set: (value) => {
                  cfg.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => cfg.primary_action_color || defaultConfig.primary_action_color,
                set: (value) => {
                  cfg.primary_action_color = value;
                  window.elementSdk.setConfig({ primary_action_color: value });
                }
              },
              {
                get: () => cfg.secondary_action_color || defaultConfig.secondary_action_color,
                set: (value) => {
                  cfg.secondary_action_color = value;
                  window.elementSdk.setConfig({ secondary_action_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => cfg.font_family || defaultConfig.font_family,
              set: (value) => {
                cfg.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => Number(cfg.font_size || defaultConfig.font_size),
              set: (value) => {
                cfg.font_size = Number(value);
                window.elementSdk.setConfig({ font_size: Number(value) });
              }
            }
          };
        },
        mapToEditPanelValues: function (config) {
          const cfg = config || defaultConfig;
          return new Map([
            ["main_title", cfg.main_title || defaultConfig.main_title],
            ["subtitle", cfg.subtitle || defaultConfig.subtitle],
            ["category_section_title", cfg.category_section_title || defaultConfig.category_section_title],
            ["save_limit_label", cfg.save_limit_label || defaultConfig.save_limit_label]
          ]);
        }
      });
    } else {
      // Sans SDK, appliquer config par défaut
      document.addEventListener("DOMContentLoaded", function () {
        applyConfigToUI(defaultConfig);
      });
    }

    // --------- LOGIQUE DE GESTION DES DÉPENSES (API-DRIVEN) ---------
    
    // VARIABLES GLOBALES (Initialisation vide)
    let globalMonthlyData = {}; // contiendra les données de tous les mois chargées
    let selectedMonthKey = null; // ID du mois sélectionné (ex: "2025-12")
    let selectedCategoryId = null; // ID de la catégorie sélectionnée
    let searchedCategoryId = null; // ID de la catégorie recherchée

    // --- UTILS API ---
    const API_BASE_URL = "http://127.0.0.1:8000/api";
    // NOTE: On simule le mois courant comme étant le mois le plus récent retourné par l'API
    let currentMonthKey = null; 

    /**
     * Effectue un appel GET à l'API.
     * @param {string} endpoint L'endpoint relatif (ex: /data/2025-12)
     * @returns {Promise<any>}
     */
    async function apiFetch(endpoint) {
        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `Erreur HTTP ${response.status} sur ${endpoint}`);
            }
            return response.json();
        } catch (error) {
            console.error("Erreur API:", error);
            showMessage(`Erreur de connexion ou API: ${error.message}`, "error");
            return null;
        }
    }

    // Éléments DOM
    const categorySelect = document.getElementById("category-select");
    const limitInput = document.getElementById("limit-input");
    const limitForm = document.getElementById("limit-form");
    const messageBox = document.getElementById("message-box");
    const searchCategorySelect = document.getElementById("search-category-select");
    const searchDepenseTotal = document.getElementById("search-depense-total");
    const searchPlafond = document.getElementById("search-plafond");
    const searchStatus = document.getElementById("search-status");
    const monthSelect = document.getElementById("month-select");
    const currentMonthIndicator = document.getElementById("current-month-indicator");

    function getActiveCategories() {
        if (!selectedMonthKey || !globalMonthlyData[selectedMonthKey]) return [];
        return globalMonthlyData[selectedMonthKey].categories;
    }

    function showMessage(text, type) {
      if (!messageBox) return;
      messageBox.classList.remove("hidden");
      messageBox.textContent = text;
      messageBox.classList.remove("border-emerald-500", "text-emerald-300", "border-red-500", "text-red-300");

      if (type === "success") {
        messageBox.classList.add("border-emerald-500", "text-emerald-300");
      } else if (type === "error") {
        messageBox.classList.add("border-red-500", "text-red-300");
      } else {
        messageBox.classList.add("border-slate-600", "text-slate-200");
      }

      setTimeout(function () {
        messageBox.classList.add("hidden");
      }, 4000);
    }

    function getSelectedCategory() {
      const categories = getActiveCategories();
      return categories.find(function (c) { return c.id === selectedCategoryId; }) || categories[0];
    }
    
    function getSearchedCategory() {
      const categories = getActiveCategories();
      return categories.find(function (c) { return c.id === searchedCategoryId; }) || categories[0];
    }
    
    /**
     * Charge les données pour un mois donné (ou le mois par défaut si non spécifié) depuis l'API.
     * @param {string} monthKey L'ID du mois (ex: "2025-12").
     */
    async function loadMonthData(monthKey) {
        if (!monthKey) {
            // Dans un vrai scénario API, il faudrait une route pour lister les mois.
            // Pour l'instant, nous chargeons un mois par défaut connu de l'API mockée.
            monthKey = currentMonthKey || "2025-12"; 
        }

        const data = await apiFetch(`/data/${monthKey}`);
        
        if (data) {
            // Simuler la découverte des mois disponibles et du mois courant
            // Dans ce scénario simplifié, nous simulons que 2025-12 est le seul mois connu initialement.
            if (Object.keys(globalMonthlyData).length === 0) {
                 // Si c'est le premier chargement, utilisez l'ID de ce mois comme mois courant initial
                 currentMonthKey = monthKey; 
                 // Pour la simulation, chargeons aussi d'autres mois si notre mock en a:
                 // Dans un vrai scénario, on aurait besoin d'un endpoint /api/mois pour la liste.
                 
                 // Puisque nous ne pouvons pas lister les mois facilement ici,
                 // on se concentre sur le mois sélectionné (celui qu'on vient de charger).
                 globalMonthlyData[monthKey] = data;
                 selectedMonthKey = monthKey;
                 
                 refreshMonthSelect([monthKey]); // On ne peut lister que ce qu'on connaît
                 
            } else {
                globalMonthlyData[monthKey] = data;
                selectedMonthKey = monthKey;
            }
            
            // Tenter de sélectionner la première catégorie si aucune n'est sélectionnée
            if (data.categories.length > 0) {
                if (!selectedCategoryId || !data.categories.find(c => c.id === selectedCategoryId)) {
                    selectedCategoryId = data.categories[0].id;
                }
                if (!searchedCategoryId || !data.categories.find(c => c.id === searchedCategoryId)) {
                    searchedCategoryId = data.categories[0].id;
                }
            }

            updateAllViews();
        }
    }


    function updateAllViews() {
        const isCurrentMonth = selectedMonthKey === currentMonthKey;
        
        // Gérer l'indicateur "Mois en cours"
        if (currentMonthIndicator) {
            currentMonthIndicator.classList.toggle('hidden', !isCurrentMonth);
        }
        
        // Bloquer la modification du plafond si ce n'est pas le mois en cours
        const isEditable = isCurrentMonth && selectedMonthKey !== null;
        if (limitInput) limitInput.disabled = !isEditable;
        const saveBtn = document.getElementById("save-limit-btn");
        if (saveBtn) saveBtn.disabled = !isEditable;
        
        if (!isCurrentMonth && selectedMonthKey) {
            showMessage(`Affichage des données pour ${globalMonthlyData[selectedMonthKey].nom}. La modification des plafonds est désactivée.`, "info");
        } else {
             messageBox.classList.add("hidden");
        }
        
        // Mettre à jour les autres sélecteurs/affichages
        refreshCategorySelect();
        refreshSearchCategorySelect();
        updateLimitInput();
        updateSearchDisplay();
        redrawChart();
    }
    
    /**
     * Remplir le sélecteur de mois.
     * NOTE: Cette fonction devrait idéalement être alimentée par un endpoint /api/months listant tous les IDs.
     * Pour l'instant, elle liste les mois connus dans globalMonthlyData.
     */
    function refreshMonthSelect(monthKeys = Object.keys(globalMonthlyData)) {
        if (!monthSelect) return;
        monthSelect.innerHTML = "";
        
        // Tri inverse (du plus récent au plus ancien)
        monthKeys.sort().reverse().forEach(function(key) {
            const opt = document.createElement("option");
            opt.value = key;
            opt.textContent = globalMonthlyData[key].nom || key;
            if (key === selectedMonthKey) opt.selected = true;
            monthSelect.appendChild(opt);
        });
    }


    function refreshCategorySelect() {
      if (!categorySelect) return;
      categorySelect.innerHTML = "";
      getActiveCategories().forEach(function (cat) {
        const opt = document.createElement("option");
        opt.value = cat.id;
        opt.textContent = cat.nom;
        if (cat.id === selectedCategoryId) opt.selected = true;
        categorySelect.appendChild(opt);
      });
    }

    function refreshSearchCategorySelect() {
      if (!searchCategorySelect) return;
      searchCategorySelect.innerHTML = "";
      getActiveCategories().forEach(function (cat) {
        const opt = document.createElement("option");
        opt.value = cat.id;
        opt.textContent = cat.nom;
        if (cat.id === searchedCategoryId) opt.selected = true;
        searchCategorySelect.appendChild(opt);
      });
    }

    function updateLimitInput() {
      const cat = getSelectedCategory();
      if (limitInput && cat) limitInput.value = (cat.plafond || 0).toString();
    }

    function updateSearchDisplay() {
      const cat = getSearchedCategory();
      if (!searchDepenseTotal || !searchPlafond || !searchStatus || !cat) {
           searchDepenseTotal.textContent = "N/A";
           searchPlafond.textContent = "N/A";
           searchStatus.textContent = "Aucune donnée de catégorie sélectionnée.";
           return;
      }
      
      const depense = cat.depense || 0;
      const plafond = cat.plafond || 0;
      
      searchDepenseTotal.textContent = depense.toFixed(0) + "€";
      searchPlafond.textContent = plafond.toFixed(0) + "€";
      
      if (depense > plafond && plafond > 0) {
        searchStatus.textContent = `Attention: ${cat.nom} dépasse le plafond de ${(depense - plafond).toFixed(0)}€.`;
        searchStatus.classList.remove("text-slate-400", "text-emerald-400");
        searchStatus.classList.add("text-red-400");
      } else if (depense > 0 && plafond > 0) {
        searchStatus.textContent = `${cat.nom} est à ${((depense / plafond) * 100).toFixed(0)}% d'utilisation de son plafond.`;
        searchStatus.classList.remove("text-slate-400", "text-red-400");
        searchStatus.classList.add("text-emerald-400");
      } else {
         searchStatus.textContent = `Dépenses de ${cat.nom} : ${depense.toFixed(0)}€. Plafond : ${plafond.toFixed(0)}€.`;
         searchStatus.classList.remove("text-red-400", "text-emerald-400");
         searchStatus.classList.add("text-slate-400");
      }
    }

    // --- LOGIQUE DE MISE À JOUR (PUT) ---
    async function handleLimitFormSubmit(event) {
        event.preventDefault();

        if (!selectedMonthKey || !selectedCategoryId || limitInput.disabled) {
            showMessage("Impossible d'enregistrer. Sélectionnez un mois et une catégorie modifiables.", "error");
            return;
        }

        const nouveauPlafond = parseFloat(limitInput.value);
        if (isNaN(nouveauPlafond) || nouveauPlafond < 0) {
            showMessage("Veuillez entrer un plafond valide (numérique positif).", "error");
            return;
        }
        
        const currentCategory = getSelectedCategory();

        const endpoint = `/plafond/${selectedMonthKey}/${selectedCategoryId}`;

        try {
            // 1. Appel PUT pour MODIFIER le plafond
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plafond: nouveauPlafond })
            });

            const result = await response.json();

            if (!response.ok) {
                showMessage(result.detail || "Échec de la mise à jour du plafond.", "error");
                return;
            }
            
            showMessage(result.message || "Plafond enregistré avec succès!", "success");
            
            // 2. Appel GET pour RECHARGER L'ÉTAT MIS À JOUR (Re-fetching)
            // Ceci assure que la page reflète la modification.
            await loadMonthData(selectedMonthKey); 

        } catch (error) {
            console.error("Erreur lors de la mise à jour:", error);
            showMessage(`Erreur de connexion ou API: ${error.message}`, "error");
        }
    }

    // --------- GESTION DES ÉVÉNEMENTS ---------

    document.addEventListener("DOMContentLoaded", function () {
        // 1. Démarrer le chargement des données
        // Charge le mois par défaut (ex: 2025-12)
        loadMonthData(currentMonthKey || "2025-12"); 

        // 2. Gestion du changement de mois
        if (monthSelect) {
            monthSelect.addEventListener("change", function () {
                const newMonthKey = this.value;
                if (!globalMonthlyData[newMonthKey]) {
                    // Si le mois n'est pas encore chargé (hypothétique si on avait une liste complète)
                    loadMonthData(newMonthKey); 
                } else {
                    selectedMonthKey = newMonthKey;
                    // Réinitialiser la catégorie sélectionnée au premier élément du nouveau mois
                    const categories = getActiveCategories();
                    if (categories.length > 0) {
                        selectedCategoryId = categories[0].id;
                        searchedCategoryId = categories[0].id;
                    }
                    updateAllViews();
                }
            });
        }
        
        // 3. Gestion du changement de catégorie (formulaire de plafond)
        if (categorySelect) {
            categorySelect.addEventListener("change", function () {
                selectedCategoryId = this.value;
                updateLimitInput(); // Met à jour l'input avec la valeur de la catégorie sélectionnée
            });
        }
        
        // 4. Gestion du formulaire de plafond (bouton "Enregistrer")
        if (limitForm) {
            limitForm.addEventListener("submit", handleLimitFormSubmit);
        }

        // 5. Gestion du changement de catégorie (recherche)
        if (searchCategorySelect) {
            searchCategorySelect.addEventListener("change", function () {
                searchedCategoryId = this.value;
                updateSearchDisplay(); // Met à jour l'affichage de la catégorie recherchée
            });
        }
        
        // 6. Gestion des onglets (même si les données sont maintenant dynamiques)
        document.querySelectorAll(".tab-button").forEach(function (button) {
            button.addEventListener("click", function () {
                // Change les classes pour le style du bouton
                document.querySelectorAll(".tab-button").forEach(b => {
                    b.classList.remove("border-orange-500", "text-white");
                    b.classList.add("border-transparent", "text-slate-400", "hover:text-slate-200", "hover:border-slate-500");
                });
                this.classList.remove("border-transparent", "text-slate-400", "hover:text-slate-200", "hover:border-slate-500");
                this.classList.add("border-orange-500", "text-white");

                // Gère l'affichage du panneau
                const targetId = this.getAttribute("data-target");
                document.querySelectorAll(".chart-panel").forEach(panel => {
                    panel.classList.add("hidden");
                });
                document.getElementById(targetId).classList.remove("hidden");
                
                // Redessine le graphique après le changement d'onglet
                if (targetId === 'chart-depenses' || targetId === 'chart-utilisation') {
                    redrawChart();
                } else if (targetId === 'chart-recherche') {
                    updateSearchDisplay();
                }
            });
        });

    });


    // --------- FONCTIONS DE DESSIN DE GRAPHIQUES (SANS CHANGER LA LOGIQUE) ---------
    const categoryColors = [
      { bg: "linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)", light: "#60a5fa", solid: "#3b82f6" },  // Bleu
      { bg: "linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)", light: "#a78bfa", solid: "#8b5cf6" },  // Violet
      { bg: "linear-gradient(135deg, #ec4899 0%, #db2777 100%)", light: "#f472b6", solid: "#ec4899" },  // Rose
      { bg: "linear-gradient(135deg, #f59e0b 0%, #d97706 100%)", light: "#fbbf24", solid: "#f59e0b" }   // Ambre
    ];

    function redrawChart() {
      drawVerticalChart();
      drawUsageChart();
    }

function drawVerticalChart() {
      const container = document.getElementById("vertical-chart");
      if (!container) return;
      
      container.innerHTML = "";
      container.className = "w-full h-full flex gap-3 relative pl-10"; 

      const categories = getActiveCategories();
      if (categories.length === 0) {
           container.innerHTML = `<p class="text-slate-400 text-sm absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">Aucune catégorie pour ce mois.</p>`;
           return;
      }

      // Trouver la valeur maximale réelle
      const maxDepense = Math.max(...categories.map(function(c) { return c.depense || 0; }), 1);
      const maxPlafond = Math.max(...categories.map(function(c) { return c.plafond || 0; }), 1);
      let actualMaxValue = Math.max(maxDepense, maxPlafond);

      // --- AJUSTEMENT DE LA MARGE ET DE L'ÉCHELLE ---
      const step = 100;
      let maxValue = Math.ceil(actualMaxValue / step) * step;
      const margin = Math.max(100, maxValue * 0.1); 
      maxValue += margin; 
      maxValue = Math.ceil(maxValue / step) * step; 
      if (maxValue === 0) maxValue = 100;


      // --- 1. Axe Y interne (Grille et Labels) ---
      
      const yAxis = document.createElement("div");
      yAxis.className = "absolute left-0 h-full w-full pointer-events-none"; 
      
      for (let i = 0; i <= 100; i += 25) {
        const value = (i / 100) * maxValue;
        const bottom = i;
        
        const label = document.createElement("span");
        label.className = "absolute text-[9px] text-slate-400 font-medium whitespace-nowrap text-right"; 
        label.style.left = `5px`; 
        label.style.width = `35px`; 
        label.style.bottom = `calc(${bottom}% - 5px)`;
        label.textContent = value.toFixed(0) + "€";
        yAxis.appendChild(label);
        
        if (i > 0) {
            const gridLine = document.createElement("div");
            gridLine.className = "absolute border-t border-slate-700/50";
            gridLine.style.bottom = `${bottom}%`;
            gridLine.style.left = `40px`; 
            gridLine.style.right = `0`; 
            yAxis.appendChild(gridLine);
        }
      }
      container.appendChild(yAxis);


      // --- 2. Création de la zone de graphique et des Barres ---
      const chartArea = document.createElement("div");
      chartArea.className = "h-full flex items-end justify-around gap-1 flex-1 relative pb-7"; 
      
      categories.forEach(function (cat, index) {
        const depense = cat.depense || 0;
        const plafond = cat.plafond || 0;
        
        const depenseHeightPercent = (depense / maxValue) * 100;
        const plafondPositionPercent = (plafond / maxValue) * 100;
        
        const colorScheme = categoryColors[index % categoryColors.length];

        const barWrapper = document.createElement("div");
        barWrapper.className = "flex flex-col items-center gap-1 flex-1 relative h-full min-w-[50px]"; 

        const barContent = document.createElement("div");
        barContent.className = "w-full flex items-end justify-center relative flex-1"; 

        // 1. Barre solide pour la Dépense
        const depenseBar = document.createElement("div");
        depenseBar.className = "w-12 rounded-t-lg shadow-lg transition-all duration-500 z-10"; 
        depenseBar.style.height = depenseHeightPercent + "%";
        depenseBar.style.background = (depense > plafond && plafond > 0) ? "linear-gradient(135deg, #ef4444 0%, #dc2626 100%)" : colorScheme.bg; 
        depenseBar.style.minHeight = "4px";
        
        // 2. Ligne en pointillés pour le Plafond
        if (plafond > 0) {
            const plafondLine = document.createElement("div");
            // NOTE: w-16 pour que la ligne dépasse légèrement la barre w-12
            plafondLine.className = "absolute left-1/2 -translate-x-1/2 border-t-2 border-dashed w-16 z-20 transition-all duration-500";
            plafondLine.style.borderColor = colorScheme.light; 
            plafondLine.style.bottom = `calc(${plafondPositionPercent}% - 2px)`; 
            barContent.appendChild(plafondLine);
        }

        barContent.appendChild(depenseBar);


        // Étiquettes du bas
        const label = document.createElement("span");
        label.className = "text-[9px] font-medium text-slate-300 text-center"; 
        label.textContent = cat.nom;

        // Valeurs (Dépense et Plafond)
        const value = document.createElement("div");
        value.className = "flex flex-col text-center leading-tight";
        
        const depenseValue = document.createElement("span");
        depenseValue.className = "text-[10px] font-semibold"; 
        depenseValue.style.color = (depense > plafond && plafond > 0) ? "#f87171" : colorScheme.light;
        depenseValue.textContent = depense.toFixed(0) + "€";
        
        const plafondValue = document.createElement("span");
        plafondValue.className = "text-[9px] text-slate-400";
        plafondValue.textContent = "Plafond: " + plafond.toFixed(0) + "€";

        value.appendChild(depenseValue);
        value.appendChild(plafondValue);


        // Assemblage final
        barWrapper.appendChild(barContent);
        barWrapper.appendChild(value);
        barWrapper.appendChild(label);
        chartArea.appendChild(barWrapper);
      });
      
      container.appendChild(chartArea);
    }

    function drawUsageChart() {
      const container = document.getElementById("usage-chart");
      if (!container) return;
      container.innerHTML = "";
      const categories = getActiveCategories();
      if (categories.length === 0) {
           container.innerHTML = `<p class="text-slate-400 text-sm text-center">Aucune catégorie pour ce mois.</p>`;
           return;
      }

      categories.forEach(function (cat, index) {
        const plafond = cat.plafond || 0;
        const depense = cat.depense || 0;
        // Calcul du pourcentage réel par rapport au plafond
        const percentRaw = plafond > 0 ? (depense / plafond) * 100 : 0;
        // Le pourcentage pour la barre visuelle ne dépasse pas 100%
        const percentBar = Math.min(percentRaw, 100); 
        
        const colorScheme = categoryColors[index % categoryColors.length];
        
        // Calcul des montants
        const resteADepenser = Math.max(0, plafond - depense);
        const depassement = Math.max(0, depense - plafond);
        
        // --- Construction de l'élément de la catégorie ---
        const row = document.createElement("div");
        row.className = "flex flex-col gap-1";

        // 1. Ligne du haut (Nom & Pourcentage)
        const topRow = document.createElement("div");
        topRow.className = "flex items-center justify-between";

        const label = document.createElement("span");
        label.className = "text-xs font-medium text-slate-200";
        label.textContent = cat.nom;

        const percentLabel = document.createElement("span");
        percentLabel.className = "text-xs font-bold";
        // Utilisation du rouge pour le pourcentage si dépassement
        percentLabel.style.color = percentRaw > 100 ? "#f87171" : colorScheme.light; 
        // Afficher le pourcentage réel
        percentLabel.textContent = Math.round(percentRaw) + "%" + (depassement > 1 ? " (DÉPASSÉ)" : "");

        topRow.appendChild(label);
        topRow.appendChild(percentLabel);

        // 2. Barre de progression (visuel)
        const barBg = document.createElement("div");
        barBg.className = "w-full h-4 rounded-full bg-slate-700/50 overflow-hidden relative"; 

        const bar = document.createElement("div");
        bar.className = "h-full rounded-full transition-all duration-500";
        bar.style.width = percentBar + "%"; // Utilisation de percentBar (max 100%)
        // Utilisation du rouge pour la barre si dépassement
        bar.style.background = percentRaw > 100 ? "linear-gradient(135deg, #ef4444 0%, #dc2626 100%)" : colorScheme.bg;
        
        barBg.appendChild(bar);
        
        // 3. Ligne d'information détaillée (Dépensé | Reste / Dépassement | Plafond)
        const infoRow = document.createElement("div");
        // Utilisation de justify-between pour espacer clairement les trois informations
        infoRow.className = "flex justify-between text-[11px] font-medium mt-1";
        
        // Dépenses actuelles (Montant dépensé)
        const depenseSpan = document.createElement("span");
        depenseSpan.className = "text-slate-400";
        depenseSpan.innerHTML = `Dépensé: <span class="font-bold" style="color: ${colorScheme.light}">${depense.toFixed(0)}€</span>`;
        
        // Reste / Dépassement
        const statusSpan = document.createElement("span");
        statusSpan.className = "text-slate-400";
        
        if (depassement > 1) {
             statusSpan.innerHTML = `Dépassement: <span class="font-bold text-red-400">${depassement.toFixed(0)}€</span>`;
        } else {
             statusSpan.innerHTML = `Reste: <span class="font-bold text-emerald-400">${resteADepenser.toFixed(0)}€</span>`;
        }
        
        // Plafond total
        const plafondSpan = document.createElement("span");
        plafondSpan.className = "text-slate-400";
        plafondSpan.innerHTML = `Plafond: <span class="font-bold">${plafond.toFixed(0)}€</span>`;


        infoRow.appendChild(depenseSpan);
        infoRow.appendChild(statusSpan);
        infoRow.appendChild(plafondSpan);

        row.appendChild(topRow);
        row.appendChild(barBg);
        row.appendChild(infoRow);
        container.appendChild(row);
      });
    }

  </script>
 </body>
</html>