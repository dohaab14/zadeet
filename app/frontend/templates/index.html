<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zadeet - Tableau de Bord</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../static/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

    <div id="navbar-placeholder"></div>

    <div class="container pb-5">
        <header class="text-center mb-4">
            <h1 class="fw-bold">Tableau de Bord</h1>
            <p class="text-muted">Vue d'ensemble de vos finances</p>
        </header>

        <section class="card shadow-sm mb-4 border-0">
            <div class="card-body text-center py-4">
                <div class="text-uppercase text-secondary fw-semibold small">Solde Actuel</div>
                <div class="display-4 fw-bold" id="totalBalanceDisplay">
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                </div>
                <div class="small text-muted" id="balanceLabel">Chargement...</div>
            </div>
        </section>

        <section class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title fw-bold mb-3">Filtrer l'affichage</h5>
                <div class="row g-2 align-items-end">
                    <div class="col-md-5">
                        <label class="form-label small text-muted">Période</label>
                        <select id="filterPeriod" class="form-select">
                            <option value="current_month" selected>Mois en cours</option>
                            <option value="last_month">Mois dernier</option>
                            <option value="last_3_months">3 derniers mois</option>
                            <option value="all">Tout l'historique</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label small text-muted">Catégorie</label>
                        <select id="filterCategory" class="form-select">
                            <option value="">Toutes les catégories</option>
                            </select>
                    </div>
                    <div class="col-md-2 d-grid">
                        <button class="btn btn-primary" onclick="applyFilters(true)">Actualiser</button>
                    </div>
                </div>
            </div>
        </section>

        <div class="row mb-4 g-4">
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white fw-bold border-bottom-0">Historique (Revenus vs Dépenses)</div>
                    <div class="card-body"><canvas id="barChart"></canvas></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white fw-bold border-bottom-0">Répartition du mois</div>
                    <div class="card-body"><canvas id="pieChart"></canvas></div>
                </div>
            </div>
        </div>

        <section class="card shadow-sm mb-4">
            <div class="card-header bg-white fw-bold">Détails des transactions</div>
            <div class="list-group list-group-flush" id="transactionList">
                <div class="p-4 text-center text-muted">Chargement...</div>
            </div>
        </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/app.js"></script>

    <script>
    let barChartInstance, pieChartInstance;

    document.addEventListener("DOMContentLoaded", async () => {
        loadNavbar();     
        loadCategoriesIntoSelect(); 
        
        // 1. Charger les données globales (Solde + Graphs backend 3 mois)
        await loadDashboard(); 
        
        // 2. Charger uniquement la liste des transactions récentes (sans écraser les graphs)
        await applyFilters(false); 
    });

    // --- A. CHARGEMENT INTELLIGENT (BACKEND) ---
    async function loadDashboard() {
        try {
            // Appel vers ta route optimisée
            const res = await fetch('/api/dashboard/stats'); 
            const data = await res.json();

            // 1. Mise à jour du solde
            const solde = data.balance;
            const el = document.getElementById('totalBalanceDisplay');
            el.innerText = new Intl.NumberFormat('fr-FR', {style:'currency', currency:'EUR'}).format(solde);
            el.className = `display-4 fw-bold ${solde >= 0 ? 'text-success' : 'text-danger'}`;
            document.getElementById('balanceLabel').innerText = solde >= 0 ? "Vos finances sont saines" : "Attention au découvert";

            // 2. Mise à jour des graphiques avec les données du backend
            updateChartsFromData(data.charts.bar.labels, data.charts.bar.revenus, data.charts.bar.depenses, 
                                 data.charts.pie.labels, data.charts.pie.data, 'bar');

        } catch(e) { console.error("Erreur dashboard", e); }
    }

    // --- B. LISTE DES TRANSACTIONS & FILTRES ---
    async function applyFilters(updateCharts = true) {
        const period = document.getElementById('filterPeriod').value;
        const catId = document.getElementById('filterCategory').value;
        
        // Construction de l'URL avec les filtres
        const params = new URLSearchParams({ period });
        if(catId) params.append('category_id', catId);

        try {
            const res = await fetch(`/api/transactions/?${params}`); // Note le /api/
            const transactions = await res.json();
            
            // Toujours mettre à jour la liste
            updateList(transactions);

            // Ne mettre à jour les graphiques QUE si c'est une demande explicite (clic bouton)
            // Sinon on garde les graphiques "Last 3 months" chargés par loadDashboard() au démarrage
            if (updateCharts) {
                updateChartsFromTransactions(transactions);
            }
        } catch(e) { console.error("Erreur filtres", e); }
    }

    function updateList(transactions) {
        const container = document.getElementById('transactionList');
        if(!transactions.length) {
            container.innerHTML = '<div class="p-4 text-center text-muted">Aucune transaction trouvée pour cette période.</div>';
            return;
        }

        container.innerHTML = transactions.map(t => `
            <div class="list-group-item d-flex justify-content-between align-items-center px-3 py-2">
                <div>
                    <div class="fw-bold">${t.label}</div>
                    <div class="small text-muted">
                        ${t.date} • ${t.category_name || 'Autre'} 
                        ${t.parent_name !== 'Autre' && t.parent_name !== t.category_name ? `(${t.parent_name})` : ''}
                    </div>
                </div>
                <div class="fw-bold ${t.category_type==='revenu'?'text-success':'text-danger'}">
                    ${t.category_type==='revenu'?'+':'-'} ${new Intl.NumberFormat('fr-FR', {style:'currency', currency:'EUR'}).format(t.amount)}
                </div>
            </div>
        `).join('');
    }

    // --- C. OUTILS POUR LES GRAPHIQUES ---

    // Cas 1: Données venant du Backend (Au chargement)
    function updateChartsFromData(labels, dataRev, dataDep, pieLabels, pieData) {
        // Bar Chart
        const ctxBar = document.getElementById('barChart');
        if(barChartInstance) barChartInstance.destroy();
        barChartInstance = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Revenus', data: dataRev, backgroundColor: '#198754' },
                    { label: 'Dépenses', data: dataDep, backgroundColor: '#dc3545' }
                ]
            }
        });

        // Pie Chart
        const ctxPie = document.getElementById('pieChart');
        if(pieChartInstance) pieChartInstance.destroy();
        pieChartInstance = new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieData,
                    backgroundColor: ['#0d6efd','#6610f2','#6f42c1','#d63384','#fd7e14','#ffc107','#20c997']
                }]
            }
        });
    }

    // Cas 2: Données calculées en JS (Quand on filtre)
    function updateChartsFromTransactions(transactions) {
        // Préparation Bar Chart (Simplifié pour le filtrage : on groupe tout, ou par jour si besoin)
        // Ici on fait un simple "Total Revenu vs Total Dépense" de la sélection
        const totalRev = transactions.filter(t => t.category_type === 'revenu').reduce((sum, t) => sum + t.amount, 0);
        const totalDep = transactions.filter(t => t.category_type === 'depense').reduce((sum, t) => sum + t.amount, 0);

        // Préparation Pie Chart
        const catMap = {};
        transactions.filter(t => t.category_type === 'depense').forEach(t => {
            const key = t.category_name || 'Autre';
            catMap[key] = (catMap[key] || 0) + t.amount;
        });

        updateChartsFromData(
            ['Sélection'], // Label Bar
            [totalRev],    // Data Revenu
            [totalDep],    // Data Dépense
            Object.keys(catMap), // Labels Pie
            Object.values(catMap) // Data Pie
        );
    }

    // --- D. UTILITAIRE ---
    async function loadCategoriesIntoSelect() {
        try {
            const res = await fetch('/api/categories/');
            const cats = await res.json();
            const select = document.getElementById('filterCategory');
            
            cats.forEach(c => {
                select.innerHTML += `<option value="${c.id}" class="fw-bold">${c.name}</option>`;
                if(c.subcategories) {
                    c.subcategories.forEach(sub => {
                        select.innerHTML += `<option value="${sub.id}">&nbsp;&nbsp;↳ ${sub.name}</option>`;
                    });
                }
            });
        } catch(e) {}
    }
    </script>
</body>
</html>