<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zadeet - Accueil</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../static/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

    <div id="navbar-placeholder"></div>

    <div class="container pb-5">
        <header class="text-center mb-4">
            <div class="mb-3">
                <img src="/static/logo.png" alt="Zadeet Logo" style="height: 120px; width: auto;">
            </div>
            <h1 class="fw-bold">Accueil</h1>
            <p class="text-muted">Vue d'ensemble de vos finances</p>
        </header>

        <section class="card shadow-sm mb-4 border-0">
            <div class="card-body text-center py-4">
                <div class="text-uppercase text-secondary fw-semibold small">Solde Actuel</div>
                <div class="display-4 fw-bold" id="totalBalanceDisplay">
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                </div>
                <div class="small text-muted" id="balanceLabel">Chargement...</div>
            </div>
        </section>

        <section class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title fw-bold mb-3">Filtrer l'affichage</h5>
                <div class="row g-2 align-items-end">
                    <div class="col-md-5">
                        <label class="form-label small text-muted">Période</label>
                        <select id="filterPeriod" class="form-select">
                            <option value="current_month">Mois en cours</option>
                            <option value="last_month">Mois dernier</option>
                            <option value="last_3_months" selected>3 derniers mois</option>
                            <option value="all">Tout l'historique</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label small text-muted">Catégorie</label>
                        <select id="filterCategory" class="form-select">
                            <option value="">Toutes les catégories</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-grid">
                        <button class="btn btn-primary" onclick="applyFilters(true)">Actualiser</button>
                    </div>
                </div>
            </div>
        </section>

        <div class="row mb-4 g-4">
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white fw-bold border-bottom-0">Historique (Revenus vs Dépenses)</div>
                    <div class="card-body"><canvas id="barChart"></canvas></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white fw-bold border-bottom-0">Répartition du mois</div>
                    <div class="card-body"><canvas id="pieChart"></canvas></div>
                </div>
            </div>
        </div>

        <section class="card shadow-sm mb-4">
            <div class="card-header bg-white fw-bold">Détails des transactions</div>
            <div class="list-group list-group-flush" id="transactionList">
                <div class="p-4 text-center text-muted">Chargement...</div>
            </div>
        </section>

        <section class="card shadow-sm mb-4">
            <div class="card-header bg-white fw-bold">Totaux par catégorie</div>
            <div class="list-group list-group-flush" id="categoryTotalsList">
                <div class="p-4 text-center text-muted">Chargement...</div>
            </div>
        </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/app.js"></script>

    <script>
    let barChartInstance, pieChartInstance;

    document.addEventListener("DOMContentLoaded", async () => {
        loadNavbar();     
        await loadCategoriesIntoSelect(); 
        
        await loadDashboard(); 
        
        // Charger liste + totaux avec filtres par défaut
        await applyFilters(true); 
    });

    // --- A. CHARGEMENT INTELLIGENT (BACKEND) ---
    async function loadDashboard() {
        try {
            const res = await fetch('/api/dashboard/stats'); 
            const data = await res.json();

            const solde = data.balance;
            const el = document.getElementById('totalBalanceDisplay');
            el.innerHTML = ''; // Enlever le spinner
            el.innerText = new Intl.NumberFormat('fr-FR', {style:'currency', currency:'EUR'}).format(solde);
            el.className = `display-4 fw-bold ${solde >= 0 ? 'text-success' : 'text-danger'}`;
            document.getElementById('balanceLabel').innerText = solde >= 0 ? "Vos finances sont saines" : "Attention au découvert";

            updateChartsFromData(data.charts.bar.labels, data.charts.bar.revenus, data.charts.bar.depenses, 
                                 data.charts.pie.labels, data.charts.pie.data);
        } catch(e) { console.error("Erreur dashboard", e); }
    }

    // --- B. LISTE DES TRANSACTIONS & FILTRES ---
    async function applyFilters(updateCharts = true) {
        const period = document.getElementById('filterPeriod').value;
        const catId = document.getElementById('filterCategory').value;
        
        const params = new URLSearchParams({ period });
        if(catId) params.append('category_id', catId);

        try {
            // 1. Charger les transactions
            const res = await fetch(`/api/transactions/?${params}`);
            const transactions = await res.json();
            updateList(transactions);

            // 2. Mettre à jour les graphiques si demandé
            if (updateCharts) {
                updateChartsFromTransactions(transactions);
            }

            // 3. Charger les totaux par catégorie avec les mêmes filtres
            await loadCategoryTotals(period, catId);

        } catch(e) { 
            console.error("Erreur filtres", e); 
        }
    }

    function updateList(transactions) {
        const container = document.getElementById('transactionList');
        if(!transactions.length) {
            container.innerHTML = '<div class="p-4 text-center text-muted">Aucune transaction trouvée pour cette période.</div>';
            return;
        }

        container.innerHTML = transactions.map(t => `
            <div class="list-group-item d-flex justify-content-between align-items-center px-3 py-2">
                <div>
                    <div class="fw-bold">${t.label}</div>
                    <div class="small text-muted">
                        ${t.date} • ${t.category_name || 'Autre'} 
                        ${t.parent_name !== 'Autre' && t.parent_name !== t.category_name ? `(${t.parent_name})` : ''}
                    </div>
                </div>
                <div class="fw-bold ${t.category_type==='revenu'?'text-success':'text-danger'}">
                    ${t.category_type==='revenu'?'+':'-'} ${new Intl.NumberFormat('fr-FR', {style:'currency', currency:'EUR'}).format(t.amount)}
                </div>
            </div>
        `).join('');
    }

    // --- C. TOTAUX PAR CATÉGORIE ---
    async function loadCategoryTotals(period, catId = null) {
        const container = document.getElementById('categoryTotalsList');
        
        const params = new URLSearchParams({ period });
        if (catId) params.append('category_id', catId);

        try {
            const res = await fetch(`/api/dashboard/category-totals/?${params.toString()}`);
            const data = await res.json();

            console.log('Totaux catégories:', data); // Debug

            if (!data.length) {
                container.innerHTML = '<div class="p-4 text-center text-muted">Aucun total disponible pour cette période.</div>';
                return;
            }

            container.innerHTML = data.map(c => `
                <div class="list-group-item d-flex justify-content-between align-items-center px-3 py-2">
                    <div>
                        <div class="fw-bold">${c.category_name}</div>
                        <div class="small text-muted">
                            ${c.category_type === 'revenu' ? 'Revenu' : 'Dépense'}
                        </div>
                    </div>
                    <div class="fw-bold ${c.category_type === 'revenu' ? 'text-success' : 'text-danger'}">
                        ${new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(c.total)}
                    </div>
                </div>
            `).join('');
        } catch (e) {
            console.error("Erreur chargement totaux catégories", e);
            container.innerHTML = '<div class="p-4 text-center text-danger">Erreur lors du chargement.</div>';
        }
    }

    // --- D. GRAPHIQUES ---
    function updateChartsFromData(labels, dataRev, dataDep, pieLabels, pieData, pieDetails = []) {
        // --- Bar Chart ---
        const ctxBar = document.getElementById('barChart');
        if(barChartInstance) barChartInstance.destroy();
        barChartInstance = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Revenus', data: dataRev, backgroundColor: '#198754' },
                    { label: 'Dépenses', data: dataDep, backgroundColor: '#dc3545' }
                ]
            }
        });

        // --- Pie Chart ---
        const ctxPie = document.getElementById('pieChart');
        if(pieChartInstance) pieChartInstance.destroy();
        
        pieChartInstance = new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: pieLabels,
                datasets: [{ 
                    data: pieData, 
                    backgroundColor: ['#0d6efd','#6610f2','#6f42c1','#d63384','#fd7e14','#ffc107','#20c997'],
                    // On injecte les détails ici
                    customDetails: pieDetails 
                }]
            },
            options: {
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                // 1. Essayer de récupérer nos détails personnalisés (Sous-catégories)
                                if (context.dataset.customDetails && context.dataset.customDetails[context.dataIndex]) {
                                    // Chart.js gère très bien les tableaux : il fera une ligne par sous-catégorie
                                    return context.dataset.customDetails[context.dataIndex];
                                }
                                // 2. Fallback (Affichage standard si pas de détails)
                                let label = context.label || '';
                                let value = context.parsed;
                                return `${label}: ${value} €`;
                            }
                        }
                    }
                }
            }
        });
    }

    function updateChartsFromTransactions(transactions) {
        
        // --- 1. LOGIQUE POUR LE BAR CHART (HISTORIQUE PAR MOIS) ---
        const historyData = {}; 

        transactions.forEach(t => {
            let year, month;
            
            // DÉTECTION DU FORMAT DE DATE
            if (t.date.includes('/')) {
                // Cas 1 : Format Français "24/11/2025"
                const parts = t.date.split('/');
                // parts[0]=jour, parts[1]=mois, parts[2]=année
                month = parts[1];
                year = parts[2];
            } else {
                // Cas 2 : Format Standard "2025-11-24"
                const parts = t.date.split('-');
                year = parts[0];
                month = parts[1];
            }

            // On crée une clé de tri standard "2025-11"
            const monthKey = `${year}-${month}`;

            if (!historyData[monthKey]) {
                historyData[monthKey] = { rev: 0, dep: 0 };
            }

            if (t.category_type === 'revenu') historyData[monthKey].rev += t.amount;
            if (t.category_type === 'depense') historyData[monthKey].dep += t.amount;
        });

        // Tri chronologique des mois
        const sortedMonths = Object.keys(historyData).sort();

        // Préparation des données Bar Chart
        const barLabels = sortedMonths.map(m => {
            // m est "2025-11" -> on affiche "11/2025"
            const [y, mo] = m.split('-');
            return `${mo}/${y}`;
        });
        const barRev = sortedMonths.map(m => historyData[m].rev);
        const barDep = sortedMonths.map(m => historyData[m].dep);


        // --- 2. LOGIQUE POUR LE PIE CHART (HIÉRARCHIE PARENTS) ---
        const parentsData = {}; 

        transactions.filter(t => t.category_type === 'depense').forEach(t => {
            let parentKey = (t.parent_name && t.parent_name !== 'Autre') ? t.parent_name : t.category_name;
            if (!parentKey) parentKey = 'Autre';

            let subKey = t.category_name || 'Autre';

            if (!parentsData[parentKey]) {
                parentsData[parentKey] = { total: 0, subs: {} };
            }

            parentsData[parentKey].total += t.amount;

            if (!parentsData[parentKey].subs[subKey]) parentsData[parentKey].subs[subKey] = 0;
            parentsData[parentKey].subs[subKey] += t.amount;
        });

        // On prépare les tableaux pour Chart.js (Pie Chart)
        const pieLabels = Object.keys(parentsData);
        const pieValues = pieLabels.map(key => parentsData[key].total);
        
        const pieDetails = pieLabels.map(key => {
            const subCategories = parentsData[key].subs;
            return Object.keys(subCategories).map(subName => {
                let amount = subCategories[subName];
                let amountStr = new Intl.NumberFormat('fr-FR', {style:'currency', currency:'EUR'}).format(amount);
                return `${subName} : ${amountStr}`;
            });
        });

        // --- 3. ENVOI FINAL ---
        // On envoie les données séparées : Bar (par mois) et Pie (par catégorie)
        updateChartsFromData(barLabels, barRev, barDep, pieLabels, pieValues, pieDetails);
    }

    // --- E. UTILITAIRE ---
    async function loadCategoriesIntoSelect() {
        try {
            const res = await fetch('/api/categories/');
            const cats = await res.json();
            const select = document.getElementById('filterCategory');
            
            cats.forEach(c => {
                select.innerHTML += `<option value="${c.id}" class="fw-bold">${c.name}</option>`;
                if(c.subcategories) {
                    c.subcategories.forEach(sub => {
                        select.innerHTML += `<option value="${sub.id}">&nbsp;&nbsp;↳ ${sub.name}</option>`;
                    });
                }
            });
        } catch(e) {
            console.error('Erreur catégories', e);
        }
    }
    </script>
</body>
</html>
